---
import { sanityClient } from "sanity:client";
import { createImageUrlBuilder } from "@sanity/image-url";

const builder = createImageUrlBuilder(sanityClient);
function urlFor(source: any) {
  return builder.image(source);
}

const { data } = Astro.props;
const galleryData = data || await sanityClient.fetch(`*[_type == "gallery"][0]`);
const hasGallery = !!galleryData;
---

{hasGallery && (
  <section class="py-20 px-6 bg-white">
    <div class="max-w-7xl mx-auto">
      {galleryData.headline && (
        <h2 class="text-3xl md:text-4xl font-bold mb-12 text-center tracking-tight">
          {galleryData.headline}
        </h2>
      )}

      <div id="gallery-grid" class="columns-1 md:columns-2 lg:columns-3 gap-4 space-y-4">
        {galleryData.images?.map((image: any) => (
          <div class="break-inside-avoid cursor-zoom-in group">
            <img
              src={urlFor(image).width(600).url()}
              data-full={urlFor(image).width(1200).url()}
              alt={image?.alt || "Gallery image"}
              draggable="false"
              oncontextmenu="return false;"
              class="w-full h-auto rounded-lg shadow-sm group-hover:shadow-md transition-all duration-300 select-none"
              loading="lazy"
            />
          </div>
        ))}
      </div>
    </div>

    <div
      id="lightbox"
      class="fixed inset-0 z-50 hidden bg-black/95 flex items-center justify-center p-4 cursor-zoom-out opacity-0 transition-opacity duration-300"
    >
      <button class="absolute top-6 right-6 text-white text-4xl hover:text-gray-300 z-50">&times;</button>
      <img
        id="lightbox-img"
        src=""
        alt="Full screen view"
        class="max-w-full max-h-[90vh] object-contain shadow-2xl rounded-sm pointer-events-none select-none"
      />
    </div>
  </section>
)}

<script>
  const grid = document.getElementById('gallery-grid') as HTMLElement | null;
  const lightbox = document.getElementById('lightbox') as HTMLElement | null;
  const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement | null;

  if (grid) {
    grid.addEventListener('click', (e: Event) => {
      const target = e.target as Element | null;
      if (!target) return;
      const clickedImage = target.closest('img') as HTMLImageElement | null;
      if (!clickedImage) return;

      const fullSizeUrl = clickedImage.getAttribute('data-full');

      if (fullSizeUrl && lightboxImg && lightbox) {
        lightboxImg.src = fullSizeUrl;
        lightbox.classList.remove('hidden');
        setTimeout(() => {
          lightbox.classList.remove('opacity-0');
        }, 10);
      }
    });
  }

  if (lightbox) {
    lightbox.addEventListener('click', () => {
      if (!lightbox) return;
      lightbox.classList.add('opacity-0');
      setTimeout(() => {
        lightbox.classList.add('hidden');
        if (lightboxImg) lightboxImg.src = '';
      }, 300);
    });
  }
</script>